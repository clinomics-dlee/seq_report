<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<!-- #. 화면 기본 head 추가 -->
<th:block th:replace="layout/head"></th:block>
</head>

<body class="pace-done">
	<form name="searchForm" id="searchForm" method="post">
		<input type="hidden" name="startDate" id="startDate" value="" />
		<input type="hidden" name="finishDate" id="finishDate" value="" />
	</form>
	<!-- begin #page-loader -->
	<div id="page-loader" class="fade show">
		<div class="material-loader">
			<svg class="circular" viewBox="25 25 50 50">
				<circle class="path" cx="50" cy="50" r="20" fill="none" stroke-width="2" stroke-miterlimit="10"></circle>
			</svg>
			<div class="message">Loading</div>
		</div>
	</div>
	<!-- end #page-loader -->

	<!-- begin #page-container -->
	<div id="page-container"
		class="fade page-sidebar-fixed page-header-fixed">
		<!-- begin #header -->
		<th:block th:replace="layout/top"></th:block>
		<!-- end #header -->
		<!-- begin #sidebar -->
		<th:block th:replace="layout/left"></th:block>
		<!-- end #sidebar -->
		<!-- begin #content -->
		<div id="content" class="content">
			<!-- begin breadcrumb -->
			<ol class="breadcrumb pull-right">
				<li class="breadcrumb-item">Home</li>
				<li class="breadcrumb-item">Setting</li>
				<li class="breadcrumb-item active">Item</li>
			</ol>
			<!-- end breadcrumb -->
			<!-- begin page-header -->
			<h1 class="page-header">Item<small> </small></h1>
			<!-- end page-header -->
			<!-- begin save form -->
			
				<!-- begin panel -->
				<div class="panel panel-inverse">
					<!-- begin panel-heading -->
					<div class="panel-heading">
						<div class="panel-heading-btn">
							<a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-default" data-click="panel-expand">
								<i class="fa fa-expand"></i>
							</a>
							<a id="reload" href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-success">
								<i class="fa fa-redo"></i>
							</a>
							<!-- 
							<a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-warning" data-click="panel-collapse"><i class="fa fa-minus"></i></a>
							<a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-danger" data-click="panel-remove"><i class="fa fa-times"></i></a>
							 -->
						</div>
						<h4 class="panel-title">Bundle</h4>
					</div>
					<!-- end panel-heading -->
					<!-- begin panel-body -->
					<div id="panel-body" class="panel-body">
						<table id="listTable" class="table " style="width: 100%;">
							<thead>
								<tr>
									<th data-orderable="false" width="20px">No</th>
									<th class="text-nowrap text-center" data-orderable="true" width="80px">Name</th>
									<th class="text-nowrap text-center" data-orderable="true">Code</th>
									<th class="text-nowrap text-center" data-orderable="true">Example</th>
									<th class="text-nowrap text-center" data-orderable="true">Select</th>
									<th class="text-nowrap text-center" data-orderable="true">Width</th>
									<th class="text-nowrap text-center" data-orderable="true">Type</th>
									<th class="text-nowrap text-center" data-orderable="true" width="50px">Order</th>
									<th class="text-nowrap text-center" data-orderable="true" width="50px"> </th>
									<th class="text-nowrap text-center" data-orderable="true" width="50px">Not Null</th>
									<th class="text-nowrap text-center" data-orderable="true" width="50px">개인정보</th>
									<th class="text-nowrap text-center" data-orderable="true" width="50px">Active</th>
								</tr>
							</thead>
						</table>
					</div>
					<!-- end panel-body -->
				</div>
				<!-- end panel -->
				
				<!-- begin panel -->
				<div class="panel panel-inverse" data-sortable-id="form-validation-2">
					<!-- begin panel-heading -->
					<div class="panel-heading">
						<div class="panel-heading-btn">
						
						</div>
						<h4 class="panel-title">Registration</h4>
					</div>
					<!-- end panel-heading -->
					<!-- begin panel-body -->
					<div class="panel-body">
						<form id="frm_new" data-parsley-validate="true">
							
							<div class="form-group row m-b-15">
								<label class="col-md-4 col-sm-4 col-form-label">Sample item name</label>
								<div class="col-md-8 col-sm-8">
									<input type="text" class="form-control" data-parsley-required="true" placeholder="" name="name" />
								</div>
							</div>
							
							<div class="form-group row m-b-15">
								<label class="col-md-4 col-sm-4 col-form-label">Sample item code</label>
								<div class="col-md-8 col-sm-8">
									<input type="text" class="form-control" data-parsley-required="true" placeholder="" name="nameCode" />
								</div>
							</div>
							
							<div class="form-group row m-b-15">
								<label class="col-md-4 col-sm-4 col-form-label">Example value</label>
								<div class="col-md-8 col-sm-8">
									<input type="text" class="form-control" placeholder="" name="exampleValue" />
								</div>
							</div>
							
							<div class="form-group row m-b-15">
								<label class="col-md-4 col-sm-4 col-form-label">Select value (,)</label>
								<div class="col-md-8 col-sm-8">
									<input type="text" class="form-control" placeholder="" name="selectValue" />
								</div>
							</div>
							
							<div class="form-group row m-b-15">
								<label class="col-md-4 col-sm-4 col-form-label">Excel width</label>
								<div class="col-md-8 col-sm-8">
									<input type="text" class="form-control" data-parsley-type="number" placeholder="" name="width" />
								</div>
							</div>
							<div class="form-group row m-b-15">
								<label class="col-md-4 col-sm-4 col-form-label">Type</label>
								<div class="col-md-8 col-sm-8">
									<input type="text" class="form-control" placeholder="" name="type" />
								</div>
							</div>
							<div class="form-group row m-b-15">
								<label class="col-md-4 col-sm-4 col-form-label">Order :</label>
								<div class="col-md-8 col-sm-8">
									<input type="text" class="form-control" data-parsley-type="number" placeholder="" name="ord" />
								</div>
							</div>
							
							<div class="form-group row m-b-15">
								<label class="col-md-4 col-sm-4 col-form-label">Not Null :</label>
								<div class="col-md-8 col-sm-8">
									<div class="switcher switcher-success">
										<input type="checkbox" name="notNull" id="chk_not_null" value="true" >
										<label for="chk_not_null"></label>
									</div>
								</div>
							</div>
							<input type="hidden" name="active" value="true" />
						</form>
							
						<hr/>
						<div class="form-group row m-b-0">
							<label class="col-md-4 col-sm-4 col-form-label">&nbsp;</label>
							<div class="col-md-8 col-sm-8">
								<button id="btn_new" class="btn btn-green" >Save</button>
							</div>
						</div>
					</div>
					<!-- end panel-body -->
				
			</div>
			<!-- end save form -->
		</div>

		<!-- end #content -->
		<!-- begin scroll to top btn -->
		<!-- end scroll to top btn -->
	</div>
	<!-- end page container -->


<script th:inline="javascript">
	// #. 시작
	$(document).ready(function() {
		App.init();
		TableManageDefault.init();
		doList();
		$("#reload").on("click", function() {
			listTable.ajax.reload();
		});

	});
	
	var listTable;
	var storeName;
	var count;

	var token = $("meta[name='_csrf']").attr("content");
	var header = $("meta[name='_csrf_header']").attr("content");
	//ajax Data List
	function doList() {
		listTable = $("#listTable").DataTable({
			processing : true, serverSide : true,
			stateSave : false, destory : true,
			paginate : true, sStripeEven: '', sStripeOdd: '',
			scrollX : true, 
			searching : false, ordering : false,
			scrollCollapse : true, fixedColumns : true,
            select: {
                style: 'single'
            },
			ajax : {
				url : "/set/item/get",
				type : "GET",
				dataType : "json",
				contentType : "application/json; charset=utf-8",
				beforeSend : function(xhr) {
					xhr.setRequestHeader(header, token);
				},
				data : function(d) {
					var params = {
						pgNmb : d.start < 0 ? 0 : (d.start / d.length),
						pgrwc : d.length,
						srchVal : d.search.value
					}
					return params;
				},
				dataSrc : function(data) {
					// 점포이름을 페이지 헤더에 넣는다.
					$("#error-text").remove();
					$("#listTable tbody").show();
					data.draw = 0;

					return data.data;
				},
				error : function(error) {
					$("#listTable > tbody").html('<tr><td valign="top" colspan="10" class="text-center dataTables_empty">empty</td></tr>');
					$("#_table_processing").css("display", "none");

					swal({
						title : "asdfasdf",
						text : "asdfasdf",
						icon : "error"
					});
					Pace.stop();
				}
			},
			columns : [{
        		className : 'text-center',
				render : function(data, type, row, meta) {
					page = meta.settings.oAjaxData;
					return "<strong>" + (meta.row + 1 + (page.pgNmb * page.pgrwc)) + "</strong>";
				}
			}, {
				data : "name",
				render : function(data, type, row) {
					return data;
				}
			}, {
				data : "nameCode",
				render : function(data, type, row) {
					return data;
				}
			}, {
				data : "exampleValue",
				className : "",
				render : function(data, type, row) {
					return '<input type="text" data-parsley-required="true" id="txt_example_' + row.id + '"'
						+ ' data-parsley-errors-container="#error_table"'
						+ ' class="form-control form-control-sm width-120" value="' + (data ? data : "") + '"/>';
				}
			}, {
				data : "selectValue",
				className : "",
				render : function(data, type, row) {
					return '<input type="text" data-parsley-required="true" id="txt_select_' + row.id + '"'
						+ ' data-parsley-errors-container="#error_table"'
						+ ' class="form-control form-control-sm width-120" value="' + (data ? data : "") + '"/>';
				}
			}, {
				data : "width",
				className : "",
				render : function(data, type, row) {
					return '<input type="text" data-parsley-required="true" id="txt_width_' + row.id + '"'
						+ ' data-parsley-errors-container="#error_table"'
						+ ' class="form-control form-control-sm width-100" value="' + (data ? data : "") + '"/>';
				}
			}, {
				data : "type",
				className : "",
				render : function(data, type, row) {
					return '<input type="text" data-parsley-required="true" id="txt_type_' + row.id + '"'
						+ ' data-parsley-errors-container="#error_table"'
						+ ' class="form-control form-control-sm width-100" value="' + (data ? data : "") + '"/>';
				}
			}, {
				data : "ord",
				className : "",
				render : function(data, type, row) {
					return '<input type="text" data-parsley-type="number" id="txt_ord_' + row.id + '"'
						+ ' data-parsley-errors-container="#error_table"'
						+ ' class="form-control form-control-sm width-50" value="' + data + '"/>';
				}
			}, {
				className : "",
				render : function(data, type, row) {
					return '<button onClick="edit(' + row.id + ', this)" class="btn btn-primary btn-sm m-l-5">Save</button>';
				}
			}, {
				data : "notNull",
				className : "text-center",
				render : function(data, type, row) {
					var checked = "";
					if (data) checked = "checked";
					var html = '<div class="custom-control custom-switch">';
					html += '<input class="custom-control-input" id="chk_not_null_' + row.id + '" type="checkbox" onClick="edit(' + row.id + ', this)" ' + checked + '/>';
					html += '<label class="custom-control-label" for="chk_not_null_' + row.id + '"></label>';
					html += '</div>';
					return html;
				}
			}, {
				data : "visible",
				className : "text-center",
				render : function(data, type, row) {
					var checked = "";
					if (data) checked = "checked";
					var html = '<div class="custom-control custom-switch">';
					html += '<input class="custom-control-input" id="chk_visible_' + row.id + '" type="checkbox" onClick="edit(' + row.id + ', this)" ' + checked + '/>';
					html += '<label class="custom-control-label" for="chk_visible_' + row.id + '"></label>';
					html += '</div>';
					return html;
				}
			}, {
				data : "active",
				className : "text-center",
				render : function(data, type, row) {
					var checked = "";
					if (data) checked = "checked";
					
					var html = '<div class="custom-control custom-switch">';
					html += '<input class="custom-control-input" id="chk_active_' + row.id + '" type="checkbox" onClick="edit(' + row.id + ', this)" ' + checked + '/>';
					html += '<label class="custom-control-label" for="chk_active_' + row.id + '"></label>';
					html += '</div>';
					
					return html;
				}
			}, {
				data : "id",
                visible: false,
				render : function(data, type, row) {
					return row.id;
				}
			}],

			//datatable export sample
			dom : "lBfrtip",
			buttons : [ {
				extend : "excel",
				title : "Member_" + moment().format("YYYYMMDDHHmmss")
			} ],
			lengthMenu : [ [ 10, 50, 100, 500, -1 ], [ 10, 50, 100, 500, "ALL" ] ],
			initComplete : function(setting, json) {
			},
			drawCallback : function( settings ) {
				/* FormSliderSwitcher.init();
				
				$(document).on('change', '[data-render="switchery"]', function() {
					edit($(this).prop('value'), $(this).prop('checked'));
			    }); */
		    }
		});
		
		/* $('#listTable').on('click', 'tbody tr', function(e) {
			if ($(this).hasClass('selected') ) {
	            $(this).removeClass('selected');
	        } else {
	        	listTable.$('tr.selected').removeClass('selected');
	            $(this).addClass('selected');
	        }
		}); */
	}
	
	$(document).on("click", "#btn_new", function() {
		
		if (!$('#frm_new').parsley().validate()) {
			return;	
		}
		$.ajax({
			url : "/set/item/add",
			type : 'post',
			dataType : 'json',
			beforeSend : function(xhr) {
				xhr.setRequestHeader(header, token);
			},
			data : JSON.stringify($('#frm_new').serializeObject()),
			contentType : "application/json;charset=utf-8",
			success : function(data) {
				
				if (data.result == "00") {
					CommonMsg.save(function() {
						$("#frm_new")[0].reset();
						listTable.ajax.reload();
					});
				} else {
					CommonMsg.error(function() { });
				}
			},
			error : function(data) {
				CommonMsg.error(function() {
					
				});
			}
		});
	});
	
	function edit(id, element) {
		var elementId = $(element).attr('id');
		var data = { id : id }; 
		
		if ($(element).prop('tagName').startsWith("BUTTON")) {
			
			data.exampleValue = $("#txt_example_" + id).val();
			data.selectValue = $("#txt_select_" + id).val();
			data.width = $("#txt_width_" + id).val();
			data.type = $("#txt_type_" + id).val();
			data.ord = $("#txt_ord_" + id).val();
			
		} else if (elementId.startsWith("chk_visible")) {
			data.visible = $(element).is(":checked");
		} else if (elementId.startsWith("chk_active")) {
			data.active = $(element).is(":checked");
		} else {
			data.notNull = $(element).is(":checked");
		}
		
		$.ajax({
			url : "/set/item/save",
			type : 'post',
			dataType : 'json',
			beforeSend : function(xhr) {
				xhr.setRequestHeader(header, token);
			},
			data : JSON.stringify(data),
			contentType : "application/json;charset=utf-8",
			success : function(data) {

				if (data.result == "00") {
					CommonMsg.save(function() { });
				} else if (!data.result.startsWith("0")) {
					CommonMsg.error(function() { });
				}
			},
			error : function(data) {
				CommonMsg.error(function() {
					
				});
			}
		});
	}
	
</script>
</body>
</html>